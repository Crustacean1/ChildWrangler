FROM --platform=$BUILDPLATFORM docker.io/tonistiigi/xx AS xx
FROM --platform=$BUILDPLATFORM rust:alpine AS builder
COPY --from=xx / /
RUN apk add clang lld

WORKDIR /wrangler
COPY ./wrangler ./

ARG TARGETPLATFORM
ARG BUILDPLATFORM

RUN xx-cargo build -vv --release --target-dir /build --bin modem_connector && \
	xx-verify /build/$(xx-cargo --print-target-triple)/release/modem_connector	
RUN mv /build/$(xx-cargo --print-target-triple)/release /

FROM --platform=$TARGETPLATFORM gcr.io/distroless/static-debian12 

WORKDIR /wrangler

COPY --from=builder /release/modem_connector /wrangler/

ENTRYPOINT ["/wrangler/modem_connector"]


